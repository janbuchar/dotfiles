#!/usr/bin/env python

import json
import os
import socket
import sys
import re
import subprocess


def run(*cmd):
    process = subprocess.run(cmd, stdout=subprocess.PIPE, check=True)
    return process.stdout.decode().splitlines()


def run_bg(*cmd):
    subprocess.Popen(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)


def get_kwin_windows_in_activity():
    """Get window info from KWin using kwin-list-windows helper"""
    try:
        output = run(os.path.join(os.path.dirname(__file__), "kwin-list-windows"))
        windows = []
        for line in output:
            parts = line.split("\t", 2)
            if len(parts) >= 3:
                windows.append({
                    "resourceName": parts[0],
                    "resourceClass": parts[1],
                    "caption": parts[2]
                })
        return windows
    except:
        return []


def extract_session(title):
    match = re.search(r'qutebrowser\s*\[(.*)\]$', title)

    if not match:
        return None

    return match.group(1)


def open_through_socket(session, url):
    sockdir = "/run/user/{}/qutebrowser/{}/runtime".format(os.getuid(), session)
    sockfile = os.path.join(sockdir, os.listdir(sockdir)[0])

    sock = socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)
    sock.connect(sockfile)

    sock.sendall(json.dumps({
        "args": [url],
        "target_arg": None,
        "version": "1.0.4",
        "protocol_version": 1,
        "cwd": os.getenv("PWD")
    }).encode() + b"\n")


def get_glide_profiles():
    """Get available Glide profiles via gl --list-profiles."""
    try:
        gl_path = os.path.join(os.path.dirname(__file__), "gl")
        return run(gl_path, "--list-profiles")
    except:
        return []


if __name__ == "__main__":
    url = sys.argv[1]
    current_activity = run("qdbus", "org.kde.ActivityManager", "/ActivityManager/Activities", "CurrentActivity")[0]
    activity_name = run("qdbus", "org.kde.ActivityManager", "/ActivityManager/Activities", "ActivityName", current_activity)[0]

    # Check if current activity matches a Glide profile
    glide_profiles = get_glide_profiles()
    if activity_name.lower() in glide_profiles:
        run_bg(os.path.join(os.path.dirname(__file__), "gl"), activity_name, url)
        sys.exit(0)

    # Fall back to qutebrowser
    kwin_windows = get_kwin_windows_in_activity()
    for win in kwin_windows:
        session = extract_session(win["caption"])
        if session is not None:
            open_through_socket(session, url)
            sys.exit(0)

    run_bg("qb", activity_name.replace(" ", ""), url)

