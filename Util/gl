#!/usr/bin/env python3
"""Glide browser profile launcher."""

import argparse
import configparser
import os
import sqlite3
import subprocess
import sys

GLIDE_DIR = os.path.expanduser("~/.glide/glide")
GLIDE_BIN = "/opt/glide-browser-bin/glide-bin"


def error(msg: str) -> None:
    """Show error dialog via yad and exit."""
    subprocess.run([
        "yad",
        "--image=dialog-error",
        "--title=gl",
        f"--text={msg}",
        "--button=OK:0",
        "--no-markup",
    ], check=False)
    sys.exit(1)


def get_store_id() -> str:
    """Parse profiles.ini to find the StoreID."""
    profiles_ini = os.path.join(GLIDE_DIR, "profiles.ini")
    config = configparser.ConfigParser()
    config.read(profiles_ini)

    for section in config.sections():
        if config.has_option(section, "StoreID"):
            return config.get(section, "StoreID")

    error("Could not find StoreID in profiles.ini")
    return ""  # unreachable


def get_profiles(store_id: str) -> dict[str, str]:
    """Query Profile Groups sqlite for profile name -> path mapping."""
    db_path = os.path.join(GLIDE_DIR, "Profile Groups", f"{store_id}.sqlite")

    if not os.path.exists(db_path):
        error(f"Profile database not found: {db_path}")

    conn = sqlite3.connect(f"file:{db_path}?mode=ro", uri=True)
    cursor = conn.execute("SELECT name, path FROM Profiles")
    profiles = {name.lower(): path for name, path in cursor.fetchall()}
    conn.close()

    return profiles


class ProfileAction(argparse.Action):
    """Custom action that validates profile against available profiles."""

    def __call__(self, parser, namespace, values, option_string=None):
        if values is None:
            setattr(namespace, self.dest, None)
            return

        store_id = get_store_id()
        profiles = get_profiles(store_id)

        profile_lower = values.lower()
        if profile_lower not in profiles:
            available = ", ".join(profiles.keys())
            error(f"Unknown profile: {values}\n\nAvailable: {available}")

        setattr(namespace, self.dest, profiles[profile_lower])


def main() -> None:
    store_id = get_store_id()
    profiles = get_profiles(store_id)

    parser = argparse.ArgumentParser(
        description="Glide browser profile launcher",
    )
    parser.add_argument(
        "-l", "--list-profiles",
        action="store_true",
        help="List available profiles and exit",
    )
    parser.add_argument(
        "profile",
        nargs="?",
        action=ProfileAction,
        help="Profile name (case-insensitive)",
    )
    parser.add_argument(
        "url",
        nargs="*",
        help="URLs to open",
    )

    args = parser.parse_args()

    if args.list_profiles:
        for name in profiles:
            print(name)
        sys.exit(0)

    if args.profile is None:
        parser.error("profile is required")

    profile_path = os.path.join(GLIDE_DIR, args.profile)
    os.execv(GLIDE_BIN, [GLIDE_BIN, "--profile", profile_path] + args.url)


if __name__ == "__main__":
    main()
